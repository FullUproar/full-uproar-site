generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id         Int      @id @default(autoincrement())
  name       String
  slug       String   @unique
  priceCents Int
  imageUrl   String
  stock      Int
  createdAt  DateTime @default(now())
}

model Merch {
  id               Int          @id @default(autoincrement())
  name             String
  slug             String       @unique
  description      String
  category         String
  priceCents       Int
  imageUrl         String?
  sizes            String?
  featured         Boolean      @default(false)
  createdAt        DateTime     @default(now()) @db.Timestamp(6)
  tags             String?
  printifyId       String?
  blueprintId      Int?
  printProviderId  Int?
  variantMapping   String?
  isPrintify       Boolean?     @default(false)
  isNew            Boolean?     @default(false)
  isBestseller     Boolean?     @default(false)
  colors           String?
  material         String?      @db.VarChar(255)
  careInstructions String?
  fitDescription   String?      @db.VarChar(255)
  weight           String?      @db.VarChar(255)
  dimensions       String?      @db.VarChar(255)
  updatedAt        DateTime?    @default(now()) @updatedAt
  apparelType      String?      @db.VarChar(50)
  fit              String?      @db.VarChar(50)
  isLimitedEdition Boolean?     @default(false)
  releaseDate      DateTime?    @db.Timestamp(6)
  viewCount        Int          @default(0)
  archived         Boolean      @default(false)
  inventory        Inventory[]
  images           MerchImage[]
  orderItems       OrderItem[]
  reviews          Review[]
}

model Game {
  id                  Int            @id @default(autoincrement())
  title               String
  tagline             String?
  description         String
  story               String?        @db.Text
  priceCents          Int
  players             String
  timeToPlay          String
  ageRating           String         @db.VarChar(20)
  imageUrl            String?
  isBundle            Boolean        @default(false)
  isPreorder          Boolean        @default(true)
  featured            Boolean        @default(false)
  bundleInfo          String?
  createdAt           DateTime       @default(now())
  stock               Int            @default(0)
  reservedStock       Int            @default(0)
  slug                String         @unique
  tags                String?
  category            String?        @default("GAME") @db.VarChar(10)
  howToPlay           String?
  components          String?
  videoUrl            String?        @db.VarChar(255)
  updatedAt           DateTime       @default(now()) @updatedAt
  launchDate          DateTime?
  isNew               Boolean?       @default(false)
  isBestseller        Boolean?       @default(false)
  playerCountCustom   String?        @db.VarChar(255)
  playTimeCustom      String?        @db.VarChar(255)
  setupTime           String?        @db.VarChar(255)
  difficulty          String?        @db.VarChar(255)
  designer            String?        @db.VarChar(255)
  artist              String?        @db.VarChar(255)
  publisher           String?        @default("Full Uproar Games") @db.VarChar(255)
  releaseYear         Int?
  bggUrl              String?        @db.VarChar(255)
  playerCount         String?        @default("TWO_TO_FOUR") @db.VarChar(20)
  playTime            String?        @default("MEDIUM") @db.VarChar(20)
  whatsInTheBox       String?
  leadDesigner        String?        @db.VarChar(255)
  leadArtist          String?        @db.VarChar(255)
  additionalDesigners String?
  additionalArtists   String?
  launchYear          Int?
  launchMonth         Int?
  launchDay           Int?
  launchHour          Int?
  launchMinute        Int?
  viewCount           Int            @default(0)
  archived            Boolean        @default(false)
  images              GameImage[]
  inventory           GameInventory?
  orderItems          OrderItem[]
  reviews             Review[]
  designComponents    DesignComponent[]
  gameNightGames      GameNightGame[]    // Games added to game night lineups
}

model Comic {
  id          Int      @id @default(autoincrement())
  title       String
  episode     String
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())
}

model NewsPost {
  id        Int      @id @default(autoincrement())
  title     String
  excerpt   String
  content   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model EmailSubscriber {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
}

model Artwork {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  imageUrl     String
  category     String
  tags         String?
  createdAt    DateTime @default(now())
  largeUrl     String?
  thumbnailUrl String?
  chaosMode    Boolean  @default(false)
}

model Inventory {
  id       Int     @id @default(autoincrement())
  merchId  Int
  size     String?
  quantity Int     @default(0)
  reserved Int     @default(0)
  merch    Merch   @relation(fields: [merchId], references: [id])
}

model GameInventory {
  id       Int  @id @default(autoincrement())
  gameId   Int  @unique
  quantity Int  @default(0)
  reserved Int  @default(0)
  game     Game @relation(fields: [gameId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([gameId])
}

model Order {
  id                    String               @id @default(cuid())
  userId                String?
  customerEmail         String
  customerName          String
  customerPhone         String?
  shippingAddress       String
  billingAddress        String?
  status                String               @default("pending")
  totalCents            Int
  shippingCents         Int                  @default(0)
  taxCents              Int                  @default(0)
  refundAmountCents     Int                  @default(0)
  paymentIntentId       String?
  paymentMethod         String?
  paidAt                DateTime?            @db.Timestamp(6)
  shippedAt             DateTime?            @db.Timestamp(6)
  deliveredAt           DateTime?            @db.Timestamp(6)
  cancelledAt           DateTime?            @db.Timestamp(6)
  refundedAt            DateTime?            @db.Timestamp(6)
  trackingNumber        String?
  shippingMethod        String?
  shippingCarrier       String?
  shippingLabelUrl      String?
  estimatedDeliveryDate DateTime?            @db.Timestamp(6)
  notes                 String?
  internalNotes         String?
  createdAt             DateTime             @default(now()) @db.Timestamp(6)
  updatedAt             DateTime             @default(now()) @updatedAt @db.Timestamp(6)
  user                  User?                @relation(fields: [userId], references: [id])
  items                 OrderItem[]
  statusHistory         OrderStatusHistory[]
  shippingLabels        ShippingLabel[]
  returns               Return[]
  tickets               SupportTicket[]
  orderNotes            OrderNote[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id          Int          @id @default(autoincrement())
  orderId     String
  itemType    String
  gameId      Int?
  merchId     Int?
  merchSize   String?
  quantity    Int
  priceCents  Int
  game        Game?        @relation(fields: [gameId], references: [id])
  merch       Merch?       @relation(fields: [merchId], references: [id])
  order       Order        @relation(fields: [orderId], references: [id])
  returnItems ReturnItem[]
}

model OrderStatusHistory {
  id        Int      @id @default(autoincrement())
  orderId   String
  status    String
  notes     String?
  createdAt DateTime @default(now()) @db.Timestamp(6)
  order     Order    @relation(fields: [orderId], references: [id])
}

model Settings {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @default(now()) @updatedAt

  @@index([key])
}

model GameImage {
  id        Int      @id @default(autoincrement())
  gameId    Int
  imageUrl  String
  alt       String?
  isPrimary Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model MerchImage {
  id        Int      @id @default(autoincrement())
  merchId   Int
  imageUrl  String
  alt       String?
  isPrimary Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  merch     Merch    @relation(fields: [merchId], references: [id], onDelete: Cascade)
}

model Review {
  id        Int      @id @default(autoincrement())
  gameId    Int?
  merchId   Int?
  userId    String
  userName  String
  rating    Int
  title     String
  comment   String
  verified  Boolean  @default(false)
  helpful   Int      @default(0)
  unhelpful Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  game      Game?    @relation(fields: [gameId], references: [id])
  merch     Merch?   @relation(fields: [merchId], references: [id])

  @@index([gameId])
  @@index([merchId])
  @@index([userId])
}

model ProductView {
  id          Int      @id @default(autoincrement())
  productType String
  productId   Int
  userId      String?
  sessionId   String
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([productType, productId])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
}

model UserActivity {
  id         Int      @id @default(autoincrement())
  userId     String
  action     String
  targetType String
  targetId   Int
  metadata   String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model User {
  id            String        @id @default(cuid())
  clerkId       String        @unique
  email         String        @unique
  username      String?       @unique
  displayName   String?
  avatarUrl     String?
  bio           String?
  favoriteQuote String?
  role          UserRole      @default(USER) // Primary role for backwards compatibility
  roles         UserRoleAssignment[] // Multiple roles support
  isActive      Boolean       @default(true)
  lastLogin     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @default(now()) @updatedAt
  
  // Customer Membership
  membershipTier     MembershipTier  @default(FREE)
  membershipExpiry   DateTime?       // NULL = no expiry, for subscriptions
  membershipStarted  DateTime?       // When they first got a paid tier
  employeeDiscount   Int            @default(0) // Percentage discount for employees
  lifetimeValue      Int            @default(0) // Total spent in cents
  
  // Payment
  stripeCustomerId String?   @unique
  
  // SMS Consent & Marketing
  phoneNumber        String?      @unique
  smsConsent         Boolean      @default(false)
  smsConsentDate     DateTime?    // When they opted in
  smsConsentIP       String?      // IP address when consented
  smsConsentMethod   String?      // "checkout", "account", "campaign"
  smsOptOutDate      DateTime?    // When they opted out (if applicable)
  smsVerified        Boolean      @default(false)
  smsVerificationCode String?     // Temporary code for verification
  marketingConsent   Boolean      @default(false) // General marketing consent
  
  // Security fields
  emailVerified    Boolean      @default(false)
  emailVerifiedAt  DateTime?
  isBanned         Boolean      @default(false)
  bannedAt         DateTime?
  bannedReason     String?
  isMuted          Boolean      @default(false)
  mutedUntil       DateTime?
  trustLevel       Int          @default(0) // 0=new, 1=basic, 2=member, 3=regular, 4=leader
  flagCount        Int          @default(0)
  lastFlaggedAt    DateTime?

  // Forum-specific ban (separate from site ban)
  forumBanned       Boolean      @default(false)
  forumBannedAt     DateTime?
  forumBannedReason String?
  forumBannedUntil  DateTime?    // null = permanent

  // Admin 2FA (TOTP) fields
  totpSecret          String?      // Encrypted TOTP secret for authenticator apps
  totpEnabled         Boolean      @default(false)
  totpVerifiedAt      DateTime?    // When 2FA setup was completed
  adminElevatedUntil  DateTime?    // Session elevation expiry (null = not elevated)
  
  // Cult devotion fields
  cultDevotion  Int           @default(0)
  cultLevel     Int           @default(0)
  cultLastVisit DateTime?
  
  // Future fields for gamification
  achievementPoints Int        @default(0)
  easterEggsFound   String?    // JSON array of found easter egg IDs
  
  posts             MessagePost[]
  threads           MessageThread[]
  boardInvites      BoardInvite[]
  permissions       Permission[]
  profile           UserProfile?
  sessions          UserSession[]
  addresses         UserAddress[]
  paymentMethods    UserPaymentMethod[]
  orders            Order[]
  returns           Return[]
  supportTickets    SupportTicket[]
  assignedTickets   SupportTicket[]     @relation("AssignedTickets")
  supportMessages   SupportMessage[]
  orderNotes        OrderNote[]
  inventoryAlerts   InventoryAlert[]

  // Game Night relations
  hostedGameNights     GameNight[]        @relation("HostedGameNights")
  gameNightAttendances GameNightGuest[]   @relation("GameNightAttendances")

  // Moderation relations
  reportsCreated           Report[]          @relation("ReportsCreated")
  reportsReceived          Report[]          @relation("ReportsReceived")
  reportsReviewed          Report[]          @relation("ReportsReviewed")
  moderationActionsPerformed ModerationAction[] @relation("ModerationActionsPerformed")
  moderationActionsReceived  ModerationAction[] @relation("ModerationActionsReceived")
  autoModRulesCreated      AutoModRule[]

  // Rituals relations (Afterroar)
  ritualsCreated      Ritual[]        @relation("RitualsCreated")
  ritualMemberships   RitualRegular[] @relation("RitualRegulars")

  // Game Kit relations
  createdCustomGames  CustomGameDefinition[] @relation("CreatedCustomGames")

  @@index([clerkId])
  @@index([email])
  @@index([username])
  @@index([role])
  @@index([trustLevel])
  @@index([isBanned])
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  ipAddress    String?
  userAgent    String?
  browser      String?
  os           String?
  device       String?
  city         String?
  country      String?
  lastActive   DateTime @default(now())
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  isActive     Boolean  @default(true)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([lastActive])
  @@index([expiresAt])
}

model UserProfile {
  id                 Int      @id @default(autoincrement())
  userId             String   @unique
  location           String?
  website            String?
  twitter            String?
  discord            String?
  favoriteGame       String?
  gamerTag           String?
  backgroundColor    String?  @default("#111827")
  accentColor        String?  @default("#f97316")
  showEmail          Boolean  @default(false)
  showActivity       Boolean  @default(true)
  emailNotifications Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @default(now()) @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Permission {
  id        Int       @id @default(autoincrement())
  userId    String
  resource  String
  action    String
  granted   Boolean   @default(true)
  grantedBy String?
  grantedAt DateTime  @default(now())
  expiresAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resource, action])
  @@index([userId])
  @@index([resource])
}

model UserRoleAssignment {
  id         String    @id @default(cuid())
  userId     String
  role       UserRole
  assignedBy String?
  assignedAt DateTime  @default(now())
  expiresAt  DateTime?
  notes      String?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, role])
  @@index([userId])
  @@index([role])
}

model UserAddress {
  id            String   @id @default(cuid())
  userId        String
  nickname      String?  // e.g., "Home", "Work", "Mom's House"
  isDefault     Boolean  @default(false)
  
  // Address fields
  fullName      String
  phone         String?
  street        String
  apartment     String?
  city          String
  state         String
  zipCode       String
  country       String   @default("US")
  
  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  lastUsedAt    DateTime?
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isDefault])
}

model UserPaymentMethod {
  id                String   @id @default(cuid())
  userId            String
  stripePaymentId   String   @unique // Stripe payment method ID
  type              String   // "card", "bank", etc.
  isDefault         Boolean  @default(false)
  
  // Display info (from Stripe, never store actual card numbers)
  brand             String?  // "visa", "mastercard", etc.
  last4             String?  // Last 4 digits only
  expMonth          Int?
  expYear           Int?
  
  // Metadata
  nickname          String?  // User-defined name like "Personal Card"
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt
  lastUsedAt        DateTime?
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isDefault])
}

model BoardCategory {
  id          Int             @id @default(autoincrement())
  name        String
  slug        String          @unique
  description String?
  icon        String?
  sortOrder   Int             @default(0)
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @default(now()) @updatedAt
  boards      MessageBoard[]
}

model MessageBoard {
  id          Int              @id @default(autoincrement())
  categoryId  Int?
  category    BoardCategory?   @relation(fields: [categoryId], references: [id])
  name        String
  slug        String           @unique
  description String?
  icon        String?
  sortOrder   Int              @default(0)
  isActive    Boolean          @default(true)
  isPrivate   Boolean          @default(false)
  accessLevel BoardAccessLevel @default(PUBLIC)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now()) @updatedAt
  threads     MessageThread[]
  invites     BoardInvite[]

  @@index([categoryId])
}

model BoardInvite {
  id        Int           @id @default(autoincrement())
  boardId   Int
  board     MessageBoard  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitedBy String
  invitedAt DateTime      @default(now())
  acceptedAt DateTime?

  @@unique([boardId, userId])
  @@index([userId])
}

model MessageThread {
  id         Int           @id @default(autoincrement())
  boardId    Int
  title      String
  slug       String
  authorId   String
  author     User          @relation(fields: [authorId], references: [id])
  isPinned   Boolean       @default(false)
  isLocked   Boolean       @default(false)
  viewCount  Int           @default(0)
  lastPostAt DateTime      @default(now())
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now()) @updatedAt
  posts      MessagePost[]
  board      MessageBoard  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  gameNights GameNight[]   // Game nights that use this thread as chat

  @@unique([boardId, slug])
  @@index([boardId])
  @@index([authorId])
  @@index([lastPostAt])
}

model MessagePost {
  id        Int           @id @default(autoincrement())
  threadId  Int
  authorId  String
  content   String
  isEdited  Boolean       @default(false)
  editedAt  DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @default(now()) @updatedAt
  author    User          @relation(fields: [authorId], references: [id])
  thread    MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([authorId])
}

enum BoardAccessLevel {
  PUBLIC           // Anyone can view
  MEMBERS_ONLY     // Must be logged in
  SUBSCRIBERS_ONLY // Must have premium membership
  PRIVATE          // Invite only
}

enum MerchCategory {
  APPAREL
  ACCESSORIES
  HOME_GOODS
  COLLECTIBLES
  STICKERS
  PRINTS
  OTHER
}

enum ApparelType {
  T_SHIRT
  HOODIE
  TANK_TOP
  LONG_SLEEVE
  SWEATSHIRT
  JACKET
  HAT
  OTHER
}

enum AgeRating {
  ALL_AGES
  ELEVEN_PLUS
  FOURTEEN_PLUS
  SIXTEEN_PLUS
  EIGHTEEN_PLUS
  TWENTYONE_PLUS
}

enum GameCategory {
  GAME
  MOD
  EXPANSION
  TTRPG
  BOARD_GAME
  CARD_GAME
  DICE_GAME
  PARTY_GAME
}

enum ComponentType {
  CARD_FACE
  BOX
  INSTRUCTIONS
}

enum ComponentStatus {
  IN_DRAFT
  READY_FOR_REVIEW
  READY_FOR_PRINT
}

enum PlayerCount {
  SINGLE
  TWO
  TWO_PLUS
  TWO_TO_FOUR
  TWO_TO_SIX
  THREE_TO_FIVE
  THREE_TO_SIX
  FOUR_TO_EIGHT
  PARTY
  CUSTOM
  VARIES
}

enum PlayTime {
  QUICK
  SHORT
  MEDIUM
  LONG
  EXTENDED
  VARIES
}

enum UserRole {
  GOD           // Absolute power - for info@fulluproar.com
  SUPER_ADMIN   // Full system access
  ADMIN         // Standard admin
  HR            // Human Resources
  PRODUCT_MANAGER
  MARKETING
  CUSTOMER_SERVICE
  WAREHOUSE
  ACCOUNTING
  CONTENT_CREATOR
  MODERATOR
  INTERN
  USER
  GUEST
}

enum MembershipTier {
  FREE          // Basic registered user
  AFTERROAR_PLUS // Premium subscription
  VIP           // High-value customers
  CREATOR       // Community content creators
  BETA_TESTER   // Early access group
}

model SMSConsentLog {
  id              String    @id @default(cuid())
  userId          String
  phoneNumber     String
  action          String    // "opt_in", "opt_out", "verify", "update"
  consentGiven    Boolean
  ipAddress       String?
  userAgent       String?
  method          String?   // "checkout", "account", "api", "sms_reply"
  message         String?   // The opt-in message shown to user
  timestamp       DateTime  @default(now())
  
  @@index([userId])
  @@index([phoneNumber])
  @@index([timestamp])
}

model SMSMessage {
  id              String    @id @default(cuid())
  userId          String?
  phoneNumber     String
  message         String    @db.Text
  direction       String    // "outbound" or "inbound"
  status          String    // "pending", "sent", "delivered", "failed"
  twilioSid       String?   @unique
  twilioStatus    String?
  errorMessage    String?
  campaignId      String?   // Link to marketing campaign
  sentAt          DateTime  @default(now())
  deliveredAt     DateTime?
  
  @@index([userId])
  @@index([phoneNumber])
  @@index([twilioSid])
}

model DesignComponent {
  id              String    @id @default(cuid())
  gameId          Int
  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  type            String    // ComponentType enum: CARD_FACE, BOX, INSTRUCTIONS
  name            String    // e.g., "Hack Your Deck card face 001"
  description     String?   @db.Text
  
  status          String    @default("IN_DRAFT") // ComponentStatus enum
  
  // Preview image (lightweight PNG for admin panel)
  previewUrl      String?
  
  // Tracking
  notes           String?   @db.Text
  sortOrder       Int       @default(0)
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastReviewedAt  DateTime?
  approvedBy      String?   // User ID who approved
  
  @@index([gameId])
  @@index([type])
  @@index([status])
  @@index([sortOrder])
}

model ImpossibleMerch {
  id              Int       @id @default(autoincrement())
  title           String
  slug            String    @unique
  tagline         String?   // "The breakfast of champions who hate mornings"
  description     String    @db.Text
  impossiblePrice String    // "$999.99" or "Your Soul" or "3 Easy Payments of Your Dignity"
  imageUrl        String?
  category        String?   // "Food", "Vehicles", "Weapons", "Services"
  warning         String?   // "Not FDA Approved" or "May Cause Interdimensional Travel"
  ingredients     String?   @db.Text // For food items
  features        String?   @db.Text // Bullet points of ridiculous features
  legalDisclaimer String?   @db.Text // "Full Uproar is not responsible for..."
  stockStatus     String    @default("IMPOSSIBLE") // "IMPOSSIBLE", "SOLD_OUT_FOREVER", "DISCONTINUED_BY_PHYSICS"
  rejectionReason String?   // What happens when they try to buy
  isActive        Boolean   @default(true)
  sortOrder       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([slug])
  @@index([isActive])
}

model ShippingLabel {
  id             Int       @id @default(autoincrement())
  orderId        String
  carrier        String
  trackingNumber String
  labelUrl       String
  labelPdfUrl    String?
  rate           Json?
  costCents      Int
  weight         Decimal?  @db.Decimal(10, 2)
  length         Decimal?  @db.Decimal(10, 2)
  width          Decimal?  @db.Decimal(10, 2)
  height         Decimal?  @db.Decimal(10, 2)
  isVoid         Boolean   @default(false)
  voidedAt       DateTime? @db.Timestamp(6)
  createdAt      DateTime  @default(now()) @db.Timestamp(6)
  updatedAt      DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  order          Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingNumber])
}

model Return {
  id                    Int          @id @default(autoincrement())
  rmaNumber             String       @unique
  orderId               String
  userId                String?
  customerEmail         String
  status                String       @default("requested")
  reason                String
  condition             String?
  customerNotes         String?
  internalNotes         String?
  returnShippingMethod  String?
  returnTrackingNumber  String?
  receivedAt            DateTime?    @db.Timestamp(6)
  processedAt           DateTime?    @db.Timestamp(6)
  refundAmountCents     Int?
  restockingFeeCents    Int          @default(0)
  replacementOrderId    String?
  createdAt             DateTime     @default(now()) @db.Timestamp(6)
  updatedAt             DateTime     @default(now()) @updatedAt @db.Timestamp(6)
  order                 Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user                  User?        @relation(fields: [userId], references: [id])
  items                 ReturnItem[]

  @@index([orderId])
  @@index([status])
}

model ReturnItem {
  id          Int       @id @default(autoincrement())
  returnId    Int
  orderItemId Int
  quantity    Int
  reason      String?
  condition   String?
  createdAt   DateTime  @default(now()) @db.Timestamp(6)
  return      Return    @relation(fields: [returnId], references: [id], onDelete: Cascade)
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
}

model SupportTicket {
  id                 Int              @id @default(autoincrement())
  ticketNumber       String           @unique
  accessToken        String?          @unique @default(cuid()) // For customer portal access without login
  userId             String?
  customerEmail      String
  customerName       String
  orderId            String?
  category           String
  priority           String           @default("normal")
  status             String           @default("open")
  subject            String
  assignedTo         String?
  resolvedAt         DateTime?        @db.Timestamp(6)
  satisfactionRating Int?
  tags               String[]
  createdAt          DateTime         @default(now()) @db.Timestamp(6)
  updatedAt          DateTime         @default(now()) @updatedAt @db.Timestamp(6)
  order              Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  user               User?            @relation(fields: [userId], references: [id])
  assignedUser       User?            @relation("AssignedTickets", fields: [assignedTo], references: [id])
  messages           SupportMessage[]

  @@index([status])
  @@index([customerEmail])
  @@index([orderId])
  @@index([accessToken])
}

model SupportMessage {
  id          Int           @id @default(autoincrement())
  ticketId    Int
  senderId    String?
  senderName  String?
  senderType  String        // 'customer', 'staff', 'system'
  message     String
  attachments Json?
  isInternal  Boolean       @default(false)
  createdAt   DateTime      @default(now()) @db.Timestamp(6)
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender      User?         @relation(fields: [senderId], references: [id])
}

model OrderNote {
  id        Int      @id @default(autoincrement())
  orderId   String
  userId    String
  note      String
  noteType  String   @default("general") // 'general', 'shipping', 'customer', 'issue'
  createdAt DateTime @default(now()) @db.Timestamp(6)
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([orderId])
}

model InventoryAlert {
  id           Int       @id @default(autoincrement())
  itemType     String    // 'game' or 'merch'
  itemId       Int
  itemName     String
  currentStock Int
  threshold    Int
  alertType    String    // 'low_stock', 'out_of_stock', 'restock_needed'
  isResolved   Boolean   @default(false)
  resolvedAt   DateTime? @db.Timestamp(6)
  resolvedBy   String?
  createdAt    DateTime  @default(now()) @db.Timestamp(6)
  resolver     User?     @relation(fields: [resolvedBy], references: [id])

  @@index([isResolved])
}

model EmailNotification {
  id             Int       @id @default(autoincrement())
  recipientEmail String
  recipientName  String?
  subject        String
  templateType   String
  relatedId      String?   // Could be orderId, ticketId, etc
  relatedType    String?   // 'order', 'ticket', 'return', etc
  status         String    @default("pending")
  sentAt         DateTime? @db.Timestamp(6)
  errorMessage   String?
  metadata       Json?
  createdAt      DateTime  @default(now()) @db.Timestamp(6)

  @@index([status])
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String
  properties Json
  userId     String?
  sessionId  String
  timestamp  DateTime
  pageUrl    String?
  createdAt  DateTime @default(now()) @db.Timestamp(6)

  @@index([eventType])
  @@index([userId])
  @@index([sessionId])
  @@index([timestamp])
}

// ============================================
// URL REDIRECTS (QR Codes, Short Links)
// ============================================

model Redirect {
  id          Int       @id @default(autoincrement())
  slug        String    @unique  // e.g., "fugly", "pax2025"
  destination String              // Full URL to redirect to
  name        String?             // Friendly name for admin display
  description String?             // Notes about where this is used

  // Status
  isActive    Boolean   @default(true)

  // Analytics
  scanCount   Int       @default(0)
  lastScannedAt DateTime?

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  createdBy   String?   // User ID who created it

  // Relations
  scans       RedirectScan[]

  @@index([slug])
  @@index([isActive])
}

model RedirectScan {
  id          Int       @id @default(autoincrement())
  redirectId  Int
  redirect    Redirect  @relation(fields: [redirectId], references: [id], onDelete: Cascade)

  // Tracking data
  ipAddress   String?
  userAgent   String?
  referer     String?
  country     String?
  city        String?
  device      String?   // "mobile", "desktop", "tablet"
  browser     String?
  os          String?

  // UTM parameters (if present in destination or passed through)
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  scannedAt   DateTime  @default(now())

  @@index([redirectId])
  @@index([scannedAt])
}

// ============================================
// GAME NIGHT PLANNER
// ============================================

model GameNight {
  id              String              @id @default(cuid())
  hostId          String
  host            User                @relation("HostedGameNights", fields: [hostId], references: [id])

  // Ritual relation (for recurring game nights)
  ritualId        String?
  ritual          Ritual?             @relation("RitualGameNights", fields: [ritualId], references: [id])
  ritualInstance  Int?                // Which occurrence of the ritual (1st, 2nd, 3rd...)

  // Event details
  title           String              @default("Game Night")
  description     String?
  date            DateTime
  startTime       String?             // "7:00 PM" - flexible format for display
  duration        Int?                // Expected duration in minutes
  location        String?             // Physical address or "Online" or custom
  maxGuests       Int?                // null = unlimited

  // Vibe & theming
  vibe            GameNightVibe       @default(CHILL)
  theme           String?             // Custom theme like "80s Arcade Night"
  aiSuggestions   Json?               // Stored AI suggestions (games, snacks, etc.)
  houseRules      String?             // Custom house rules for the game night

  // Team chat - linked to forum infrastructure
  chatThreadId    Int?                // Links to MessageThread for group chat
  chatThread      MessageThread?      @relation(fields: [chatThreadId], references: [id])

  // Status
  status          GameNightStatus     @default(PLANNING)

  // Reminder settings
  reminderSent    Boolean             @default(false)
  dayOfReminderSent Boolean           @default(false)

  // Metadata
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @default(now()) @updatedAt
  completedAt     DateTime?

  // Relations
  guests          GameNightGuest[]
  games           GameNightGame[]
  moments         GameNightMoment[]
  recap           GameNightRecap?

  @@index([hostId])
  @@index([date])
  @@index([status])
  @@index([ritualId])
}

model GameNightGuest {
  id              String              @id @default(cuid())
  gameNightId     String
  gameNight       GameNight           @relation(fields: [gameNightId], references: [id], onDelete: Cascade)

  // Guest identity (one of these should be set)
  userId          String?             // If they're a registered user
  user            User?               @relation("GameNightAttendances", fields: [userId], references: [id])
  guestName       String?             // For non-registered guests
  guestEmail      String?             // For sending invites/reminders
  guestPhone      String?             // Optional phone for SMS reminders

  // Invite tracking
  inviteToken     String              @unique @default(cuid()) // Magic link token
  inviteSentAt    DateTime?
  inviteMethod    String?             // "link", "email", "sms"

  // Response
  status          GuestStatus         @default(PENDING)
  respondedAt     DateTime?

  // Role at the event
  isCoHost        Boolean             @default(false)
  bringing        String?             // What they're bringing: "snacks", "drinks", etc.

  // Metadata
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @default(now()) @updatedAt

  // Game night stats for this guest
  gamesWon        Int                 @default(0)

  @@unique([gameNightId, userId])
  @@unique([gameNightId, guestEmail])
  @@index([gameNightId])
  @@index([userId])
  @@index([inviteToken])
}

model GameNightGame {
  id              String              @id @default(cuid())
  gameNightId     String
  gameNight       GameNight           @relation(fields: [gameNightId], references: [id], onDelete: Cascade)

  // Game reference (either our game or custom)
  gameId          Int?                // Links to our Game model if applicable
  game            Game?               @relation(fields: [gameId], references: [id])
  customGameName  String?             // For games not in our catalog

  // Planning
  playOrder       Int                 @default(0)
  estimatedMinutes Int?

  // Status during the night
  status          GameStatus          @default(PLANNED)
  startedAt       DateTime?
  completedAt     DateTime?

  // Winner(s)
  winnerId        String?             // GameNightGuest ID
  winnerName      String?             // Denormalized for easy display
  isTie           Boolean             @default(false)

  // Fun stats
  chaosLevel      Int?                // 1-10 rating
  notes           String?             // "Dave rage quit after losing Catan"

  createdAt       DateTime            @default(now())

  // Voting
  votes           GameNightGameVote[]

  @@index([gameNightId])
  @@index([gameId])
  @@index([playOrder])
}

// Voting for which games to play
model GameNightGameVote {
  id              String              @id @default(cuid())
  gameNightGameId String
  gameNightGame   GameNightGame       @relation(fields: [gameNightGameId], references: [id], onDelete: Cascade)

  // Who voted (either guest or userId for host)
  guestId         String?             // GameNightGuest ID
  userId          String?             // For host voting

  // Vote type
  vote            Int                 @default(1) // 1 = upvote, -1 = downvote, 0 = meh

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @default(now()) @updatedAt

  @@unique([gameNightGameId, guestId])
  @@unique([gameNightGameId, userId])
  @@index([gameNightGameId])
}

model GameNightMoment {
  id              String              @id @default(cuid())
  gameNightId     String
  gameNight       GameNight           @relation(fields: [gameNightId], references: [id], onDelete: Cascade)

  // Who captured it
  capturedById    String?             // GameNightGuest ID or host
  capturedByName  String?

  // Content
  type            MomentType          @default(NOTE)
  content         String?             // Text content or caption
  imageUrl        String?             // Photo URL if uploaded

  // Context
  gameId          String?             // Which game this moment was during

  createdAt       DateTime            @default(now())

  @@index([gameNightId])
  @@index([type])
}

model GameNightRecap {
  id              String              @id @default(cuid())
  gameNightId     String              @unique
  gameNight       GameNight           @relation(fields: [gameNightId], references: [id], onDelete: Cascade)

  // AI-generated content
  aiSummary       String?             @db.Text // Fun recap narrative
  highlights      Json?               // Key moments, winners, stats

  // Stats
  totalGamesPlayed Int               @default(0)
  totalDurationMinutes Int?
  mvpGuestId      String?             // Most wins
  chaosChampionId String?             // Highest chaos moments

  // Sharing
  isPublic        Boolean             @default(false)
  shareToken      String?             @unique

  generatedAt     DateTime            @default(now())

  @@index([shareToken])
}

// Enums for Game Night

enum GameNightVibe {
  CHILL         // Relaxed, casual games
  COMPETITIVE   // Bring your A-game
  CHAOS         // Full Uproar mode
  PARTY         // High energy, lots of people
  COZY          // Intimate, story-driven
}

enum GameNightStatus {
  PLANNING      // Still being set up
  LOCKED_IN     // Date confirmed, invites out
  IN_PROGRESS   // It's happening!
  COMPLETED     // Done, ready for recap
  CANCELLED     // Didn't happen
}

enum GuestStatus {
  PENDING       // Haven't responded
  IN            // They're coming!
  MAYBE         // On the fence
  OUT           // Can't make it
}

enum GameStatus {
  PLANNED       // On the lineup
  PLAYING       // Currently playing
  COMPLETED     // Finished
  SKIPPED       // Didn't get to it
}

enum MomentType {
  NOTE          // Text note
  PHOTO         // Image
  WINNER        // Game winner announcement
  CHAOS         // Epic chaos moment
  QUOTE         // Funny quote from the night
}

// ============================================
// MODERATION SYSTEM
// ============================================

model Report {
  id             String         @id @default(cuid())
  reporterId     String         // Who reported it
  reporter       User           @relation("ReportsCreated", fields: [reporterId], references: [id])

  // What was reported
  contentType    ReportContentType  // POST, THREAD, USER, GAME_NIGHT, etc
  contentId      String         // ID of the content (e.g., post ID, user ID)
  targetUserId   String?        // User who created the content (if applicable)
  targetUser     User?          @relation("ReportsReceived", fields: [targetUserId], references: [id])

  // Report details
  reason         ReportReason
  description    String?        @db.Text // Additional context from reporter
  url            String?        // URL where content appears (for easy navigation)

  // Status
  status         ReportStatus   @default(PENDING)
  priority       ReportPriority @default(NORMAL)

  // Resolution
  reviewedBy     String?        // Moderator who reviewed
  reviewer       User?          @relation("ReportsReviewed", fields: [reviewedBy], references: [id])
  reviewedAt     DateTime?
  resolution     String?        @db.Text // What action was taken
  resolutionType ReportResolutionType?

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt

  @@index([reporterId])
  @@index([targetUserId])
  @@index([status])
  @@index([contentType, contentId])
  @@index([createdAt])
}

model ModerationAction {
  id             String              @id @default(cuid())
  moderatorId    String
  moderator      User                @relation("ModerationActionsPerformed", fields: [moderatorId], references: [id])

  // What action was taken
  actionType     ModerationActionType
  targetUserId   String?             // User being moderated (if applicable)
  targetUser     User?               @relation("ModerationActionsReceived", fields: [targetUserId], references: [id])

  // Context
  contentType    String?             // POST, THREAD, USER, etc
  contentId      String?             // ID of content affected
  relatedReportId String?            // Report that triggered this action (if any)

  // Details
  reason         String              @db.Text
  duration       Int?                // Duration in hours (for temp bans/mutes)
  expiresAt      DateTime?           // When the action expires (for temp actions)

  // Notes
  internalNotes  String?             @db.Text // Private notes for mod team
  publicReason   String?             // Reason shown to affected user

  // Metadata
  ipAddress      String?
  userAgent      String?

  createdAt      DateTime            @default(now())

  @@index([moderatorId])
  @@index([targetUserId])
  @@index([actionType])
  @@index([createdAt])
}

// Auto-moderation triggers (keyword flags, rate limits)
model AutoModRule {
  id             String              @id @default(cuid())
  name           String
  description    String?             @db.Text

  // Rule configuration
  ruleType       AutoModRuleType
  pattern        String?             // Regex or keyword pattern
  threshold      Int?                // For rate limiting
  timeWindowMinutes Int?             // Time window for rate limits

  // Action to take
  action         AutoModActionType
  severity       ReportPriority      @default(NORMAL)

  // Status
  isActive       Boolean             @default(true)
  createdBy      String?
  creator        User?               @relation(fields: [createdBy], references: [id])

  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now()) @updatedAt

  @@index([ruleType])
  @@index([isActive])
}

// Enums for Moderation

enum ReportContentType {
  POST
  THREAD
  USER
  GAME_NIGHT
  REVIEW
  PROFILE
  OTHER
}

enum ReportReason {
  SPAM
  HARASSMENT
  HATE_SPEECH
  NSFW
  SCAM
  IMPERSONATION
  OFF_TOPIC
  MISINFORMATION
  PERSONAL_INFO
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
  ESCALATED
}

enum ReportPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum ReportResolutionType {
  NO_ACTION
  WARNING_SENT
  CONTENT_HIDDEN
  CONTENT_REMOVED
  USER_WARNED
  USER_MUTED
  USER_SUSPENDED
  USER_BANNED
  ESCALATED_TO_ADMIN
}

enum ModerationActionType {
  WARN
  MUTE
  SUSPEND
  BAN
  HIDE_CONTENT
  REMOVE_CONTENT
  LOCK_THREAD
  PIN_THREAD
  UNBAN
  UNMUTE
  RESTORE_CONTENT
}

enum AutoModRuleType {
  KEYWORD_FILTER
  SPAM_DETECTION
  RATE_LIMIT
  LINK_FILTER
  CAPS_LIMIT
  MENTION_LIMIT
}

enum AutoModActionType {
  FLAG_FOR_REVIEW
  AUTO_HIDE
  AUTO_REMOVE
  AUTO_WARN
  RATE_LIMIT_USER
}

// Afterroar Waitlist
model AfterroarWaitlist {
  id          String   @id @default(cuid())
  email       String   @unique
  tier        String?  // 'AFTERROAR' or 'AFTERROAR_PLUS'
  source      String?  // Where they signed up from
  referredBy  String?  // Referral code if any
  createdAt   DateTime @default(now())
  notifiedAt  DateTime? // When we sent launch notification
  convertedAt DateTime? // When they became a paying member

  @@index([email])
  @@index([createdAt])
}

// Rituals - Recurring game nights (Afterroar feature)
model Ritual {
  id              String   @id @default(cuid())
  creatorId       String
  creator         User     @relation("RitualsCreated", fields: [creatorId], references: [id], onDelete: Cascade)

  name            String
  description     String?  @db.Text
  imageUrl        String?

  // Recurrence settings
  recurrenceType  RecurrenceType
  dayOfWeek       Int?     // 0-6 for weekly/biweekly
  dayOfMonth      Int?     // 1-31 for monthly
  weekOfMonth     Int?     // 1-4 for "first Monday", etc.
  frequency       Int      @default(1) // Every X weeks/months
  startDate       DateTime
  endDate         DateTime? // Optional end date

  // Time settings
  startTime       String   // "19:00" format
  duration        Int?     // Minutes
  timezone        String   @default("America/Los_Angeles")

  // Campaign tracking (for RPGs)
  isCampaign      Boolean  @default(false)
  campaignName    String?
  sessionCount    Int      @default(0)

  // Settings
  isActive        Boolean  @default(true)
  maxPlayers      Int?
  autoCreateDays  Int      @default(14) // Auto-create game nights X days in advance

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  // Relations
  gameNights      GameNight[] @relation("RitualGameNights")
  regulars        RitualRegular[]

  @@index([creatorId])
  @@index([isActive])
  @@index([recurrenceType])
}

// Track regular attendees of a ritual
model RitualRegular {
  id         String   @id @default(cuid())
  ritualId   String
  ritual     Ritual   @relation(fields: [ritualId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation("RitualRegulars", fields: [userId], references: [id], onDelete: Cascade)

  role       String   @default("player") // host, co-host, player, spectator
  joinedAt   DateTime @default(now())

  @@unique([ritualId, userId])
  @@index([ritualId])
  @@index([userId])
}

enum RecurrenceType {
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

// =============================================================================
// GAME CONSTRUCTION KIT
// =============================================================================

enum CustomGameStatus {
  DRAFT
  TESTING
  PUBLISHED
  ARCHIVED
}

// Templates for game types (CAH-style, Trivia, etc.)
model GameTemplate {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String    @db.Text
  category        String    // "party", "trivia", "voting"
  iconEmoji       String?   // "üìù", "‚ùì", "üé≠"
  baseConfig      Json      // GameDefinition without cards
  cardTypes       String[]  // ["black", "white"]
  editorHints     Json?     // UI configuration for editor
  isOfficial      Boolean   @default(true)
  sortOrder       Int       @default(0)
  createdAt       DateTime  @default(now())

  games           CustomGameDefinition[]

  @@index([category])
}

// User-created game definitions
model CustomGameDefinition {
  id              String    @id @default(cuid())
  creatorId       String
  creator         User      @relation("CreatedCustomGames", fields: [creatorId], references: [id], onDelete: Cascade)

  name            String
  slug            String
  description     String?   @db.Text
  coverImageUrl   String?

  minPlayers      Int       @default(3)
  maxPlayers      Int       @default(10)

  templateId      String
  template        GameTemplate @relation(fields: [templateId], references: [id])
  gameConfig      Json      // Full GameDefinition (phases, slots, etc.)

  status          CustomGameStatus @default(DRAFT)
  shareToken      String    @unique @default(cuid())

  playCount       Int       @default(0)
  remixCount      Int       @default(0)

  // Remix tracking
  isRemixOf       String?
  parent          CustomGameDefinition?  @relation("Remixes", fields: [isRemixOf], references: [id], onDelete: SetNull)
  remixes         CustomGameDefinition[] @relation("Remixes")

  // Featured/discovery
  featuredAt      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  publishedAt     DateTime?

  cardPacks       CustomCardPack[]
  sessions        GameSession[]

  @@unique([creatorId, slug])
  @@index([creatorId])
  @@index([status])
  @@index([shareToken])
  @@index([templateId])
}

// Card packs within a custom game (like expansion packs)
model CustomCardPack {
  id              String    @id @default(cuid())
  gameId          String
  game            CustomGameDefinition @relation(fields: [gameId], references: [id], onDelete: Cascade)

  name            String
  isCore          Boolean   @default(true)  // Is this the default/required pack?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  cards           CustomCard[]

  @@index([gameId])
}

// Individual cards in a pack
model CustomCard {
  id              String    @id @default(cuid())
  packId          String
  pack            CustomCardPack @relation(fields: [packId], references: [id], onDelete: Cascade)

  cardType        String    // "black", "white", etc.
  properties      Json      // { text: "...", pick: 1, ... }
  sortOrder       Int       @default(0)

  createdAt       DateTime  @default(now())

  @@index([packId])
  @@index([cardType])
}

// =============================================================================
// LIVE GAME SESSIONS (Real-time multiplayer)
// =============================================================================

enum SessionStatus {
  WAITING     // Lobby, waiting for players
  STARTING    // Game about to start
  IN_PROGRESS // Game is active
  PAUSED      // Game paused
  COMPLETED   // Game finished normally
  ABANDONED   // Game ended early (host left, etc.)
}

// A live game session (room)
model GameSession {
  id              String        @id @default(cuid())
  roomCode        String        @unique // 6-character code like "ABCD12"

  // Link to game definition (can be from builder or template)
  gameDefinitionId String?
  gameDefinition   CustomGameDefinition? @relation(fields: [gameDefinitionId], references: [id])

  // Or use a built-in template
  templateSlug    String?       // "cah", "trivia", "uno", etc.

  // Game configuration snapshot (copied at session start)
  gameConfig      Json?         // Full game config for this session

  // Host info
  hostId          String?       // Clerk user ID (null for anonymous host)
  hostNickname    String        // Display name for host

  // Session state
  status          SessionStatus @default(WAITING)
  currentRound    Int           @default(0)
  currentPhase    String?       // Current phase identifier
  gameState       Json?         // Live game state (scores, cards, etc.)

  // Counts
  playerCount     Int           @default(0)
  spectatorCount  Int           @default(0)
  maxPlayers      Int           @default(16)

  // Settings
  isPrivate       Boolean       @default(false)
  password        String?       // Optional password for private games
  allowSpectators Boolean       @default(true)
  turnTimeLimit   Int?          // Seconds per turn (null = no limit)

  // Timestamps
  createdAt       DateTime      @default(now())
  startedAt       DateTime?
  endedAt         DateTime?
  lastActivityAt  DateTime      @default(now())

  // Relations
  players         SessionPlayer[]

  @@index([roomCode])
  @@index([status])
  @@index([hostId])
  @@index([lastActivityAt])
}

// A player in a game session
model SessionPlayer {
  id              String        @id @default(cuid())
  sessionId       String
  session         GameSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Player identity
  clerkId         String?       // Null for anonymous players
  nickname        String        // Display name
  avatarUrl       String?       // Optional avatar
  avatarEmoji     String?       // Fallback emoji avatar

  // Role in session
  isHost          Boolean       @default(false)
  isSpectator     Boolean       @default(false)

  // Proxy player support (IRL players managed by host)
  isProxy         Boolean       @default(false)  // True if this is an IRL player
  proxyManagedBy  String?       // SessionPlayer ID of who manages this proxy (usually host)

  // Player state
  isConnected     Boolean       @default(true)
  isReady         Boolean       @default(false)
  score           Int           @default(0)
  playerState     Json?         // Hand, role, etc.

  // Turn order
  turnOrder       Int?          // Position in turn order

  // Connection tracking
  joinedAt        DateTime      @default(now())
  lastSeenAt      DateTime      @default(now())
  disconnectedAt  DateTime?

  @@unique([sessionId, nickname]) // No duplicate nicknames in same session
  @@index([sessionId])
  @@index([clerkId])
}
